# Python Packages Manager

A self-hosted tool to generate weekly vulnerability and upgrade reports for Python project dependencies. It scans a full requirements list, builds a dependency tree, checks for known CVEs via **pip-audit** and OSV, suggests safe minor upgrades according to semantic versioning, and outputs CSV, HTML, and JSON reports (plus a failed-versions list) under `WeeklyReport/YYYY-MM-DD/`.

---

## Table of Contents

1. [Overview](#overview)
2. [Repository Structure](#repository-structure)
3. [Installation](#installation)
4. [Configuration via `.env`](#configuration-via-env)
5. [Usage](#usage)
   - [1. Generate Dependency Tree](#1-generate-dependency-tree)
   - [2. Run Weekly Report](#2-run-weekly-report)
   - [3. View Reports](#3-view-reports)
6. [Main Script: `GenerateReport.py`](#main-script-generatereportpy)
7. [Utilities Overview](#utilities-overview)
8. [Jinja2 Template](#jinja2-template)
9. [GitHub Workflows](#github-workflows)
10. [License](#license)

---

## Overview

`Python Packages Manager` automates weekly security and upgrade checks:

- **Dependency Tree**: Detects base packages and their transitive dependencies.
- **Vulnerability Scanning**: Integrates with [pip-audit](https://github.com/PyPA/pip-audit) and [OSV API](https://osv.dev/) for known CVEs.
- **Upgrade Suggestions**: Recommends the latest safe minor/patch versions.
- **Weekly Reports**: Produces CSV, HTML, JSON and a failed-versions text file in a date-stamped folder.

Ideal for teams tracking compliance, security posture, and upgrade planning on a regular cadence.

---

## Repository Structure

```
/ (root)
├── .github/
│   └── workflows/            # CI workflows for scheduled and on-demand runs
├── src/                      # Input data files
│   ├── requirements_full_list.txt
│   ├── base_package_list.txt
│   ├── BasePackageWithDependencies.csv  # generated by CheckDependency
│   ├── custodian.csv         # package-to-team mapping
│   └── NotUsed.txt           # packages to exclude
├── templates/                # Jinja2 templates
│   └── weekly_report.html.j2 # HTML report template
├── utils/                    # helper modules
│   ├── CheckDependency.py    # builds dependency CSV
│   ├── ConfigUtils.py        # path & parse utilities
│   ├── CustodianUtils.py     # custodian mapping & sort key
│   ├── PyPiUtils.py          # PyPI metadata fetching
│   ├── VersionSuggester.py   # safe upgrade logic
│   ├── VulnChecker.py        # pip-audit & OSV checks
│   ├── UpgradeInstruction.py # format upgrade steps
│   └── SGTUtils.py           # custom logger & time helper
├── WeeklyReport/             # output reports by date
│   └── YYYY-MM-DD/
│       ├── WeeklyReport_*.csv
│       ├── WeeklyReport_*.html
│       ├── WeeklyReport_*.json
│       └── FailedVersions_*.txt
├── GenerateReport.py         # main report generator
├── requirements.txt          # Python dependencies
└── .env                      # environment configuration
```

---

## Installation

```bash
git clone https://github.com/your-org/PythonPackagesManager.git
cd PythonPackagesManager
python3 -m venv .venv
source .venv/bin/activate
pip install -r requirements.txt
```

---

## Configuration via `.env`

Copy the `.env.example` or create `.env` in the project root:

```dotenv
FULL_RELOAD_PACKAGES=False            # If true, re-run dependency scan every time
BASE_PACKAGE_TXT=src/base_package_list.txt
BASE_PACKAGE_CSV=src/BasePackageWithDependencies.csv
CHECK_DEPENDENCY_SCRIPT=utils/CheckDependency.py
REQUIREMENTS_FILE=src/requirements_full_list.txt
CUSTODIAN_LIST=src/custodian.csv
NOTUSED_PACKAGES=src/NotUsed.txt
PIP_AUDIT_CMD="pip-audit --format json"
SEMAPHORE_NUMBER=3                    # concurrent vulnerability checks
CUSTODIAN_1=<base64-encoded name>
CUSTODIAN_2=<base64-encoded name>
PYPI_URL_TEMPLATE=https://pypi.org/pypi/{package}/json
```

- **CUSTODIAN_1**, **CUSTODIAN_2**: Base64-encoded team or owner names, decoded at runtime.  
- **SEMAPHORE_NUMBER**: Max parallel processes for pip-audit/OSV.

---

## Usage

### 1. Generate Dependency Tree

```bash
python utils/CheckDependency.py
```

- Reads `src/requirements_full_list.txt`  
- Outputs `src/BasePackageWithDependencies.csv`

---

### 2. Run Weekly Report

```bash
python GenerateReport.py --output all
```

- **--output**: one or more of `csv`, `html`, `json`, `all` (default: `all`)  

Process:
1. Parse requirements (`utils.ConfigUtils.parse_requirements`).  
2. Load base list (`utils.ConfigUtils.load_base_packages`).  
3. Fetch PyPI metadata (`utils.PyPiUtils.GetPyPiInfo`).  
4. Suggest upgrades (`utils.VersionSuggester.suggest_safe_minor_upgrade`).  
5. Scan vulnerabilities (`utils.VulnChecker.check_cv_uv`).  
6. Annotate & sort by custodian (`utils.CustodianUtils.custom_sort_key`).  
7. Render HTML with Jinja2 (`templates/weekly_report.html.j2`).  
8. Save outputs under `WeeklyReport/YYYY-MM-DD/`.

---

### 3. View Reports

Open the latest HTML report:

```bash
xdg-open WeeklyReport/$(date +%Y-%m-%d)/WeeklyReport_*.html
```

Or review CSV/JSON in your editor.

---

## Main Script: `GenerateReport.py`

The orchestrator located at the project root:

- Loads `.env` settings via `dotenv`  
- Configures a custom logger (`utils.SGTUtils.SGTFormatter`)  
- Parses CLI args (`argparse`)  
- Reads `NotUsed.txt` exclusions  
- Loops through each package: metadata, CVE check, upgrade suggestion  
- Aggregates rows, sorts, and emits CSV, HTML, JSON

Key imports:
```
get_report_paths, get_report_output_folder, parse_requirements, load_base_packages
load_custodian_map, decode_base64_env, custom_sort_key
GetPyPiInfo, suggest_safe_minor_upgrade, check_cv_uv
generate_upgrade_instruction, now_sg
```

---

## Utilities Overview

- **CheckDependency.py**: Builds `BasePackageWithDependencies.csv` from requirements.  
- **ConfigUtils.py**: Path helpers and requirements parsing.  
- **CustodianUtils.py**: Load decode custodian mapping; custom sort key.  
- **PyPiUtils.py**: Fetch PyPI JSON metadata.  
- **VersionSuggester.py**: Compute safe minor/patch version upgrades.  
- **VulnChecker.py**: Parallel pip-audit & OSV vulnerability checks.  
- **UpgradeInstruction.py**: Generate detailed upgrade steps.  
- **SGTUtils.py**: Custom log formatter and Singapore time helper.

---

## Jinja2 Template

Located at `templates/weekly_report.html.j2`:

- Renders a table with:
  - Package name (link)  
  - Current vs. suggested versions  
  - Vulnerability flags & details  
  - Custodian and upgrade instructions
- Customize CSS or add interactive scripts (e.g., DataTables).

---

## GitHub Workflows

### Scheduled Report: `.github/workflows/generate_weekly_report.yml`

- **Trigger**: Cron every Monday at UTC midnight  
- **Steps**: Checkout → Setup Python & rclone → Decode RCLONE_CONF → Run report → Commit & push outputs → Sync via rclone

### Manual/Reusable: `.github/workflows/GenerateReport.yml`

Reusable workflow for ad-hoc report generation.

---

## License

Released under the [MIT License](LICENSE).